# å‘Šåˆ« Docker Daemonï¼šå•æœº Golang éƒ¨ç½²æ–¹æ¡ˆ (Ko + Podman + Systemd)
> 2023-10-16 21:33:50

---

# å‘Šåˆ« Docker Daemonï¼šå•æœº Golang éƒ¨ç½²çš„ç»ˆææ–¹æ¡ˆ (Ko + Podman + Systemd)

åœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼ŒKubernetes (K8s) ä¼¼ä¹æˆäº†éƒ¨ç½²çš„æ ‡å‡†ç­”æ¡ˆã€‚ä½†å¯¹äºå¾ˆå¤šä¸ªäººå¼€å‘è€…ã€ä¸­å°å›¢é˜Ÿçš„å†…éƒ¨å·¥å…·ï¼Œæˆ–è€…åªæœ‰ä¸€å° VPS çš„åœºæ™¯æ¥è¯´ï¼ŒK8s æ— å¼‚äºå¤§ç‚®æ‰“èšŠå­ã€‚

äºæ˜¯æˆ‘ä»¬é€šå¸¸é€€å›åˆ° Docker Composeã€‚è™½ç„¶æ¯” K8s è½»é‡ï¼Œä½† Docker ä¾ç„¶éœ€è¦è¿è¡Œä¸€ä¸ªæ²‰é‡çš„ `dockerd` å®ˆæŠ¤è¿›ç¨‹ï¼Œä¸”å¸¸å¸¸éœ€è¦ root æƒé™ï¼Œç½‘ç»œé…ç½®ä¹Ÿè‡ªæˆä¸€æ´¾ã€‚

æœ‰æ²¡æœ‰ä¸€ç§æ–¹æ¡ˆï¼Œæ—¢èƒ½äº«å— **Go è¯­è¨€é™æ€ç¼–è¯‘** çš„çº¢åˆ©ï¼Œåˆèƒ½æ‹¥æœ‰ **å®¹å™¨åŒ–** çš„éš”ç¦»æ€§ï¼Œè¿˜èƒ½åƒ **Linux åŸç”ŸæœåŠ¡** ä¸€æ ·è¢«ç®¡ç†ï¼Ÿ

ç­”æ¡ˆå°±æ˜¯ï¼š**Ko + Podman + Systemd**ã€‚

## ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªç»„åˆï¼Ÿ

è¿™ä¸ªâ€œä¸‰å‰‘å®¢â€ç»„åˆå®Œç¾å¥‘åˆäº† Linux çš„è®¾è®¡å“²å­¦ï¼š

1.  **Ko (æ„å»º)**ï¼šGoogle å‡ºå“ã€‚æ— éœ€ Dockerfileï¼Œæ— éœ€ Docker Daemonã€‚å®ƒåˆ©ç”¨ Go çš„ç‰¹æ€§ç›´æ¥ç”Ÿæˆç¬¦åˆ OCI æ ‡å‡†çš„æç®€é•œåƒï¼ˆåŸºäº `distroless`ï¼‰ï¼Œå®‰å…¨ä¸”æé€Ÿã€‚
2.  **Podman (è¿è¡Œ)**ï¼šRedHat å‡ºå“ã€‚å®ƒæ˜¯ä¸€ä¸ª**æ— å®ˆæŠ¤è¿›ç¨‹ (Daemonless)** çš„å®¹å™¨å¼•æ“ã€‚å®ƒç›´æ¥ä½œä¸ºå­è¿›ç¨‹å¯åŠ¨å®¹å™¨ï¼Œæ— éœ€ root æƒé™ (Rootless)ï¼Œä¸”å®Œå…¨å…¼å®¹ Docker å‘½ä»¤ã€‚
3.  **Systemd (ç®¡ç†)**ï¼šLinux çš„ä¸Šå¸è¿›ç¨‹ã€‚æ—¢ç„¶æ“ä½œç³»ç»Ÿè‡ªå¸¦äº†æœ€å¼ºå¤§çš„è¿›ç¨‹ç®¡ç†å™¨ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è®© Docker Daemon å†ç®¡ä¸€æ¬¡ï¼ŸPodman å¯ä»¥ç”Ÿæˆ Systemd å•å…ƒæ–‡ä»¶ï¼Œè®©ä½ çš„å®¹å™¨åƒ `nginx` æˆ– `sshd` ä¸€æ ·å¼€æœºè‡ªå¯ã€å´©æºƒé‡å¯ã€æ—¥å¿—å½’æ¡£ã€‚

-----

## å®è·µæŒ‡å—

å‡è®¾æˆ‘ä»¬çš„é¡¹ç›®åä¸º `sphere-layout`ã€‚

### 1\. é…ç½® Ko (æ„å»ºå±‚)

é¦–å…ˆï¼Œæˆ‘ä»¬è¦åˆ©ç”¨ `ko` æ„å»ºä¸€ä¸ªæè‡´ç²¾ç®€çš„ Go é•œåƒã€‚åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.ko.yaml`ï¼š

```yaml
# .ko.yaml
# ä½¿ç”¨ distroless static é•œåƒï¼Œä»…åŒ…å« SSL è¯ä¹¦å’Œæ—¶åŒºæ•°æ®ï¼Œä½“ç§¯æå°ï¼Œå®‰å…¨æ€§æé«˜
defaultBaseImage: gcr.io/distroless/static:nonroot

builds:
  - id: app
    main: ./cmd/app
    env:
      - CGO_ENABLED=0
    ldflags:
      - -s -w # å»é™¤è°ƒè¯•ç¬¦å·ï¼Œå‡å°ä½“ç§¯
      - -X {{.Env.MODULE}}/internal/config.BuildVersion={{.Env.BUILD_VER}}
```

### 2\. æœåŠ¡å™¨é…ç½® (è¿è¡Œå±‚)

åœ¨ä½ çš„ Linux æœåŠ¡å™¨ä¸Šï¼ˆUbuntu/CentOSï¼‰ï¼Œä½ åªéœ€è¦å®‰è£… `podman`ã€‚ä¸éœ€è¦å®‰è£… Dockerã€‚

```bash
# Ubuntu
sudo apt-get update && sudo apt-get install -y podman
```

**å…³é”®ç‚¹ï¼šå¯ç”¨ User Systemd**
ä¸ºäº†å®‰å…¨ï¼Œæˆ‘ä»¬ä¸ä½¿ç”¨ root è¿è¡Œå®¹å™¨ã€‚æˆ‘ä»¬éœ€è¦å…è®¸æ™®é€šç”¨æˆ·åœ¨ä¸ç™»å½•çš„æƒ…å†µä¸‹ä¿æŒæœåŠ¡è¿è¡Œï¼š

```bash
# å¼€å¯ lingeringï¼Œå…è®¸ç”¨æˆ·æ³¨é”€åæœåŠ¡ç»§ç»­è¿è¡Œ
loginctl enable-linger $USER
```

### 3\. è‡ªåŠ¨åŒ–éƒ¨ç½² (Makefile)

è¿™æ˜¯æœ¬æ–¹æ¡ˆçš„æ ¸å¿ƒã€‚æˆ‘ä»¬å°†ä½¿ç”¨ `Makefile` å°†æ„å»ºã€ä¸Šä¼ ã€æ›´æ–°æœåŠ¡ä¸²è”èµ·æ¥ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `Makefile` ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```makefile
# ---------- é…ç½®åŒºåŸŸ ----------
# é•œåƒä»“åº“è·¯å¾„ (ä¾‹å¦‚ ghcr.io/yourname/project)
KO_REPO         := ghcr.io/go-sphere/sphere-layout
# æœåŠ¡å™¨è¿æ¥ä¿¡æ¯
REMOTE_HOST     := user@1.2.3.4
SERVICE_NAME    := sphere-layout
# ç‰ˆæœ¬æ§åˆ¶
BUILD_VER       := $(shell git describe --tags --always --dirty)
IMAGE_URL       := $(KO_REPO):latest

.PHONY: deploy-podman

# ä¸€é”®éƒ¨ç½²å‘½ä»¤
deploy-podman:
	@echo "ğŸš€ [1/3] Building & Pushing with Ko..."
	@# å¯¼å‡ºå˜é‡ä¾› .ko.yaml è¯»å–ï¼ŒåŒæ—¶æ‰“ä¸Š latest å’Œå…·ä½“ç‰ˆæœ¬å·çš„ Tag
	@export KO_DOCKER_REPO=$(KO_REPO) \
	 export MODULE=$(shell go list -m) \
	 export BUILD_VER=$(BUILD_VER) \
	; ko build ./cmd/app --bare --tags latest,$(BUILD_VER)

	@echo "ğŸšš [2/3] Deploying to $(REMOTE_HOST)..."
	@ssh $(REMOTE_HOST) '\
		# 1. æ‹‰å–æœ€æ–°é•œåƒ \
		podman pull $(IMAGE_URL) && \
		\
		# 2. åœæ­¢å¹¶æ¸…ç†æ—§å®¹å™¨ (å¦‚æœå­˜åœ¨) \
		podman stop $(SERVICE_NAME) || true && \
		podman rm $(SERVICE_NAME) || true && \
		\
		# 3. åˆ›å»ºæ–°å®¹å™¨ (æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ --name å›ºå®šåç§°) \
		podman create \
			--name $(SERVICE_NAME) \
			--restart always \
			-p 8080:8080 \
			-e GIN_MODE=release \
			$(IMAGE_URL) && \
		\
		# 4. ç”Ÿæˆ Systemd Unit æ–‡ä»¶ (Podman çš„æ€æ‰‹é”) \
		mkdir -p ~/.config/systemd/user/ && \
		podman generate systemd --new --name $(SERVICE_NAME) > ~/.config/systemd/user/container-$(SERVICE_NAME).service && \
		\
		# 5. é‡è½½é…ç½®å¹¶å¯åŠ¨æœåŠ¡ \
		systemctl --user daemon-reload && \
		systemctl --user enable --now container-$(SERVICE_NAME).service \
	'
	@echo "âœ… [3/3] Deployment Successful!"
```

-----

## æ·±å…¥è§£æï¼šä¸ºä»€ä¹ˆè¿™æ­¥æ“ä½œæ˜¯â€œæ€æ‰‹é”â€ï¼Ÿ

è¯·æ³¨æ„ Makefile ä¸­æœ€åä¸€æ®µ SSH å‘½ä»¤é‡Œçš„ `podman generate systemd`ã€‚

ä¼ ç»Ÿçš„ Docker éƒ¨ç½²ï¼Œå¦‚æœä¸å°å¿ƒé‡å¯äº†æœåŠ¡å™¨ï¼Œä½ å¾—æŒ‡æœ› Docker Daemon çš„ `restart: always` å‚æ•°ç”Ÿæ•ˆã€‚è€Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ‰§è¡Œäº† `podman generate systemd --new`ã€‚

è¿™æ¡å‘½ä»¤ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ ‡å‡†çš„ Systemd Unit æ–‡ä»¶ï¼ˆç±»ä¼¼ `nginx.service`ï¼‰ï¼Œå†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š

```ini
# container-sphere-layout.service
[Unit]
Description=Podman container-sphere-layout.service

[Service]
Restart=on-failure
ExecStart=/usr/bin/podman run --rm --replace ... (Podmanè‡ªåŠ¨ç”Ÿæˆçš„å¯åŠ¨å‚æ•°)
ExecStop=/usr/bin/podman stop ...
Type=forking
...

[Install]
WantedBy=default.target
```

è¿™æ„å‘³ç€ï¼š

1.  **å®Œå…¨æ‰˜ç®¡**ï¼šä½ çš„ Go åº”ç”¨ç°åœ¨æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€ç­‰å…¬æ°‘ã€‚
2.  **æ—¥å¿—ç»Ÿä¸€**ï¼šä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ `journalctl --user -u container-sphere-layout -f` æŸ¥çœ‹æ—¥å¿—ï¼Œæ”¯æŒæ—¶é—´è¿‡æ»¤ã€å¯¼å‡ºç­‰æ‰€æœ‰ Systemd å¼ºå¤§çš„æ—¥å¿—åŠŸèƒ½ã€‚
3.  **è‡ªæ„ˆèƒ½åŠ›**ï¼šå¦‚æœè¿›ç¨‹å´©æºƒï¼ŒSystemd ä¼šè´Ÿè´£æ‹‰èµ·ï¼›å¦‚æœæœåŠ¡å™¨é‡å¯ï¼ŒSystemd ä¼šè´Ÿè´£å¯åŠ¨ã€‚

## æ€»ç»“

é€šè¿‡ **Ko**ï¼Œæˆ‘ä»¬æŠ›å¼ƒäº†ç¹ççš„ `Dockerfile`ï¼›
é€šè¿‡ **Podman**ï¼Œæˆ‘ä»¬æŠ›å¼ƒäº†æ²‰é‡çš„ Docker Daemonï¼›
é€šè¿‡ **Systemd**ï¼Œæˆ‘ä»¬è·å¾—äº†ç”Ÿäº§çº§çš„è¿›ç¨‹ç®¡ç†èƒ½åŠ›ã€‚

è¿™å°±æ˜¯å•æœº Golang åº”ç”¨éƒ¨ç½²çš„â€œæç®€ä¸»ä¹‰â€ç¾å­¦ã€‚å¯¹äºä¸æƒ³ç»´æŠ¤ K8s é›†ç¾¤çš„å¼€å‘è€…æ¥è¯´ï¼Œè¿™æˆ–è®¸æ˜¯ç›®å‰æœ€ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚