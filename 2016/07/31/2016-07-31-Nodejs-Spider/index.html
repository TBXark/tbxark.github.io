<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>用 Node.js 写简易爬虫 | TBXark</title>
  <meta name="viewport" content="width=device-width">

  <$ if page.tags and page.tags.length %>
  	<meta name="keywords" content="<$ for tag in page.tags %>{{ tag.name }},<$ endfor %>" />
  <$ else %>
  <$ if theme.keywords %>
      <meta name="keywords" content="{{ theme.keywords }}" />
  <$ endif %>

  <meta name="description" content="爬虫
网络爬虫（又被称为网页蜘蛛，网络机器人，在FOAF社区中间，更经常的称为网页追逐者），是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本。

说到爬虫一般都会想到 Python,但是比起 Python, 会 Javascript应该更多.然后刚好我就用 Node.js 写了一个简单的爬虫, 爬取输入的优酷视频的 url 并且读取所需信息在网页上显示出来,并且在终端中用 json 显示.">
<meta property="og:type" content="article">
<meta property="og:title" content="用 Node.js 写简易爬虫">
<meta property="og:url" content="http://tbxark.site/2016/07/31/2016-07-31-Nodejs-Spider/index.html">
<meta property="og:site_name" content="TBXark">
<meta property="og:description" content="爬虫
网络爬虫（又被称为网页蜘蛛，网络机器人，在FOAF社区中间，更经常的称为网页追逐者），是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本。

说到爬虫一般都会想到 Python,但是比起 Python, 会 Javascript应该更多.然后刚好我就用 Node.js 写了一个简单的爬虫, 爬取输入的优酷视频的 url 并且读取所需信息在网页上显示出来,并且在终端中用 json 显示.">
<meta property="og:updated_time" content="2016-07-31T05:22:19.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="用 Node.js 写简易爬虫">
<meta name="twitter:description" content="爬虫
网络爬虫（又被称为网页蜘蛛，网络机器人，在FOAF社区中间，更经常的称为网页追逐者），是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本。

说到爬虫一般都会想到 Python,但是比起 Python, 会 Javascript应该更多.然后刚好我就用 Node.js 写了一个简单的爬虫, 爬取输入的优酷视频的 url 并且读取所需信息在网页上显示出来,并且在终端中用 json 显示.">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>

<body>
  <div id="container">
    <div class="mobile-nav-panel">
	<i class="icon-reorder icon-large"></i>
</div>
<header id="header">
	<h1 class="blog-title">
		<a href="/">TBXark</a>
	</h1>
	<nav class="nav">
		<ul>
			<li><a href="/">home</a></li><li><a href="/archives">archives</a></li><li><a href="/about">about</a></li>
			<!-- <li><a id="nav-search-btn" class="nav-icon" title="Search"></a></li> -->
			<!--  -->
		</ul>
	</nav>
	<div id="search-form-wrap">
		<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://tbxark.site"></form>
	</div>
</header>

    <div id="main">
      <article id="post-2016-07-31-Nodejs-Spider" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2016/07/31/2016-07-31-Nodejs-Spider/" class="article-date">
  <time datetime="2016-07-30T17:23:00.000Z" itemprop="datePublished">2016-07-31</time>
</a>
		</span>
		<span class="meta-elements author">
  <div class="article-category">
    <a class="article-category-link" href="/categories/node-js/">node.js</a>
  </div>
</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 class="article-title entry-title" itemprop="name">
      用 Node.js 写简易爬虫
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<h2 id="爬虫">爬虫</h2><blockquote>
<p>网络爬虫（又被称为网页蜘蛛，网络机器人，在FOAF社区中间，更经常的称为网页追逐者），是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本。</p>
</blockquote>
<p>说到爬虫一般都会想到 Python,但是比起 Python, 会 Javascript应该更多.<br>然后刚好我就用 Node.js 写了一个简单的爬虫, 爬取输入的优酷视频的 url 并且读取所需信息在网页上显示出来,并且在终端中用 json 显示.<br>Github: <a href="https://github.com/TBXark/YoukuInfo" target="_blank" rel="external">https://github.com/TBXark/YoukuInfo</a></p>
<a id="more"></a>
<h2 id="Node-js">Node.js</h2><blockquote>
<p>Node.js采用Google的V8引擎来执行代码。Node.js的大部分基本模块都是用JavaScript写成的。Node.js含有一系列内置模块，使得程序可以作为独立服务器运行，从而脱离Apache HTTP Server或IIS运行。</p>
</blockquote>
<p>首先介绍一下接下来或用到的一些依赖</p>
<ol>
<li><code>superagent</code> : 是nodejs里一个非常方便的客户端请求代理模块</li>
<li><code>express</code> : 是一个简洁而灵活的node.js Web应用框架, 提供一系列强大特性帮助你创建各种Web应用</li>
<li><code>cheerio</code> : jQuery 的 Node.js 实现</li>
<li><code>body-parser</code> : 用来解析请求体, 没有这个库的话 express 会解析不出 post 中的请求体</li>
<li><code>fs</code>: 用来读取本地文件</li>
</ol>
<h2 id="代码解析">代码解析</h2><h3 id="1-_引用依赖">1. 引用依赖</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> superagent = <span class="built_in">require</span>(<span class="string">'superagent'</span>);</div><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</div></pre></td></tr></table></figure>
<h3 id="2-_初始化">2. 初始化</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">app</span> = express(); <span class="comment">// 创建 `express` 对象</span></div><div class="line"></div><div class="line"><span class="keyword">app</span>.<span class="keyword">use</span>(bodyParser.json()); <span class="comment">// 请求体解析</span></div><div class="line"><span class="keyword">app</span>.<span class="keyword">use</span>(bodyParser.urlencoded());</div><div class="line"></div><div class="line"><span class="comment">// 创建路由: 路由表示应用程序端点 (URI) 的定义以及端点响应客户机请求的方式</span></div><div class="line"><span class="keyword">var</span> router = express.Router();</div><div class="line"></div><div class="line"><span class="comment">// 主页</span></div><div class="line"><span class="keyword">app</span>.<span class="built_in">get</span>('/', router);</div><div class="line"><span class="comment">// 结果页</span></div><div class="line"><span class="keyword">app</span>.<span class="keyword">post</span>('/showdetail', router);</div></pre></td></tr></table></figure>
<h3 id="3-_首页">3. 首页</h3><ol>
<li>首页内容</li>
</ol>
<p>使用表单作为需要爬取的 url 的输入源.<br>将<code>&lt;form&gt;</code>的 id 设置成<code>urlinput</code>, 然后将 <code>&lt;textarea&gt;</code> 的 <code>from</code> 设置成 <code>urlinput</code>,这样这两个控件就可以关联起来.<br>然后将加上网络请求 <code>action=&#39;/showdetail&#39; method=&#39;post&#39;</code>. 一个简单的表单提交页面就完成了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">'urlinput'</span> &gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">type</span>=<span class="string">'text'</span> <span class="attr">name</span>=<span class="string">'urls'</span> <span class="attr">form</span>=<span class="string">'urlinput'</span> <span class="attr">style</span>=<span class="string">'height: 50%; width:100%'</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'submit'</span> <span class="attr">value</span>=<span class="string">'Submit'</span> <span class="attr">style</span>=<span class="string">'width:100%; height:50'</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>渲染首页</li>
</ol>
<p>使用<code>fs.readFileSync</code>同步读取存在本地的首页内容并返回给浏览器渲染</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 读取 input 文件并且返回</span></div><div class="line"><span class="selector-tag">router</span><span class="selector-class">.get</span>(<span class="string">'/'</span>, function(req, res)&#123;</div><div class="line">  var htmlCode =  fs<span class="selector-class">.readFileSync</span>(<span class="string">'input'</span>)<span class="selector-class">.toString</span>();</div><div class="line">  res<span class="selector-class">.send</span>(htmlCode);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="4-_解析并返回数据">4. 解析并返回数据</h3><p>这一块写得比较粗糙,主要是将 post 请求体中的内容读取出来并且分割成数组,然后遍历 url 并且爬取相应的数据.<br>使用<code>cheerio</code>能很轻松的解析 html, 详情的语法可以查看<code>cheerio</code>的 文档.<br>将解析出来的内容分别拼接成 json 和 html 并返回</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">router.post('/showdetail', function(req, res)&#123;</div><div class="line">  <span class="built_in">var</span> urls = req.body.urls.<span class="built_in">split</span>(<span class="string">"\n"</span>);</div><div class="line"></div><div class="line">  <span class="built_in">var</span> <span class="built_in">content</span> = <span class="string">""</span>;</div><div class="line">  <span class="built_in">var</span> count = urls.<span class="built_in">length</span>;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">    <span class="built_in">return</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">for</span> (<span class="built_in">var</span> index <span class="keyword">in</span> urls) &#123;</div><div class="line">    <span class="built_in">var</span> url = urls[index];</div><div class="line">    <span class="keyword">if</span> (url.<span class="built_in">length</span> &gt; <span class="number">0</span> &amp;&amp; url.indexOf(<span class="string">"http://v.youku.com"</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">        superagent.<span class="built_in">get</span>(url)</div><div class="line">          .end(function (err, sres) &#123;</div><div class="line">            count = count - <span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span> (err) &#123;</div><div class="line">              <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">                res.send(<span class="built_in">content</span>);</div><div class="line">              &#125;</div><div class="line">              <span class="built_in">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">var</span> $ = cheerio.<span class="built_in">load</span>(sres.text);</div><div class="line"></div><div class="line">            <span class="built_in">var</span> irAlbumName = $('meta[name=<span class="string">"irAlbumName"</span>]').attr('<span class="built_in">content</span>');</div><div class="line">            <span class="built_in">var</span> irTitle = $('meta[name=<span class="string">"irTitle"</span>]').attr('<span class="built_in">content</span>');</div><div class="line">            <span class="built_in">var</span> keywords =  $('meta[name=<span class="string">"keywords"</span>]').attr('<span class="built_in">content</span>');</div><div class="line">            <span class="built_in">var</span> videoCode = $('input[id=<span class="string">"link4"</span>]').attr('value');</div><div class="line">            <span class="built_in">var</span> <span class="built_in">image</span> = $('a[id=<span class="string">"s_qq_haoyou1"</span>]').attr('href').<span class="built_in">split</span>(<span class="string">"pics="</span>)[<span class="number">1</span>].<span class="built_in">split</span>(<span class="string">"&amp;"</span>)[<span class="number">0</span>].replace(<span class="string">"5420"</span>, <span class="string">"5410"</span>);</div><div class="line"></div><div class="line">            <span class="built_in">var</span> jsonObj = &#123;</div><div class="line">              url: url,</div><div class="line">              <span class="built_in">title</span>: irAlbumName + irTitle,</div><div class="line">              keywords: keywords,</div><div class="line">              videoCode: videoCode,</div><div class="line">              <span class="built_in">image</span>: <span class="built_in">image</span></div><div class="line">            &#125;;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="built_in">var</span> subContent =  <span class="string">"标题:"</span> + <span class="string">"&lt;br&gt;"</span> + irAlbumName + irTitle + <span class="string">"&lt;br&gt;"</span> + <span class="string">"&lt;br&gt;"</span>;</div><div class="line">            subContent = subContent + <span class="string">"关键词:"</span> + <span class="string">"&lt;br&gt;"</span> + keywords + <span class="string">"&lt;br&gt;"</span> + <span class="string">"&lt;br&gt;"</span>;</div><div class="line">            subContent = subContent + <span class="string">"缩略图:"</span> + <span class="string">"&lt;br&gt;"</span> + <span class="string">"&lt;img src='"</span>+<span class="built_in">image</span>+<span class="string">"' /&gt;"</span> + <span class="string">"&lt;br&gt;"</span> + <span class="string">"&lt;br&gt;"</span>;</div><div class="line">            subContent = subContent + <span class="string">"通用代码:"</span> + <span class="string">"&lt;br&gt;"</span> + <span class="string">"&lt;input style='width:100%' value=\'"</span> + videoCode  + <span class="string">"\'&lt;/input&gt;"</span> + <span class="string">"&lt;br&gt;"</span> +<span class="string">"&lt;br&gt;"</span> + <span class="string">"&lt;br&gt;"</span> + <span class="string">"&lt;br&gt;"</span>;;</div><div class="line"></div><div class="line">            <span class="built_in">content</span> = <span class="built_in">content</span> + subContent;</div><div class="line"></div><div class="line">            console.<span class="built_in">log</span>( JSON.stringify(jsonObj, null, <span class="string">"\t"</span>) + <span class="string">"\n"</span>);</div><div class="line">            <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">              res.send(<span class="built_in">content</span>);</div><div class="line">            &#125;</div><div class="line">          &#125;);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        count = count - <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">          res.send(<span class="built_in">content</span>);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="4-_监听端口">4. 监听端口</h3><p>最后设置监听的端口, 完成后在终端运行 <code>node index.js</code>, 并且在浏览器中访问 <code>localhost:3000</code>就可以访问首页并且执行爬虫了</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app.listen(<span class="number">3000</span>, <span class="keyword">function</span> <span class="title"></span>() &#123;</div><div class="line">  console.log('app <span class="keyword">is</span> listening <span class="keyword">at</span> port <span class="number">3000</span>');</div><div class="line">&#125;);</div></pre></td></tr></table></figure>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/爬虫/">爬虫</a></li></ul>

			</span>
		</div>
	</footer>
	
    
<nav id="article-nav">
  
    <a href="/2016/08/12/2016-08-12-Android-quick-viewholder/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Android - 通用 Viewholder
        
      </div>
    </a>
  
  
    <a href="/2016/06/10/2016-06-10-TableViewWithT/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          使用泛型优化 UITableviewCell 的重用
        
      </div>
    </a>
  
</nav>

  
</article>





    </div>
    <div class="mb-search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:tbxark.site">
  </form>
</div>
<footer id="footer">
	<h1 class="footer-blog-title">
		<a href="/">TBXark</a>
	</h1>
	<span class="copyright">
		&copy; 2016 TBXark<br>
		Theme by <a href="http://sanographix.github.io/tumblr/apollo/" target="_blank">Apollo</a>
		Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	</span>
</footer>

    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="/js/script.js"></script>
  </div>
</body>
</html>